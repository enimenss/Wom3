<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - My ASP.NET Application</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
    <style>
    .badge-notify{
     background:red;
     margin:auto;
     -moz-transform: translate(-100%, -100%); /* For Firefox */
     -ms-transform: translate(-100%, -100%); /* for IE */
     -webkit-transform: translate(-100%, -100%); /* For Safari, Chrome, iOS */
     -o-transform: translate(-100%, -100%); /* For Opera */
    }
             .messages{
    border: 1px solid #ccc;
    width: 400px;
    height: 200px;
    padding: 10px;
    overflow-y:scroll;
    background-color:lightblue;
     word-wrap: break-word; 

     text-overflow: ellipsis;

     }

    .zaAjaxPoruke{
    border: 1px solid #ccc;
    width: 400px;
    height: 100px;
    padding: 10px;
    overflow-y:scroll;
    background-color:lightblue;
     word-wrap: break-word; 

     text-overflow: ellipsis;

     }

             .online {
    border: 1px solid #ccc;
    width: 200px;
    height: 150px;
    padding: 10px;
    overflow-y:scroll;
    background-color:lightblue;
     word-wrap: break-word; 
     text-overflow: ellipsis;

     }

 .circle{
    -webkit-border-radius:8px;
    -moz-border-radius:8px;
    border-radius:8px;
    border:1px solid #ccc;
    width:8px;
    height:8px;
    float:right;
    position:center;
    background-color:darkgreen;
    color:darkgreen;
}



             .posalji{

             }


        </style>

    <style>
.dropbtn {
    background-color:#333333;
    color: white;
    padding: 16px;
    font-size: 16px;
    border: none;
    cursor: pointer;
}

.dropbtn:hover, .dropbtn:focus {
    background-color: black;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 250px;
    overflow: auto;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

.dropdown a:hover {background-color: #f1f1f1}

.show {display:block;}

 .zaPoruke {
    border: 1px solid #ccc;
    width: 600px;
    height: 500px;
    padding: 10px;
    overflow-y:scroll;
    background-color:lightgreen;
     word-wrap: break-word; 
     text-overflow: ellipsis;
     }
</style>


   
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                @Html.ActionLink("WOM", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    @if (!string.Equals(Session["user"], "Administrator"))
                        { 

                    <li class="@(ViewBag.Title=="Profile"?"active":"")">@Html.ActionLink("Profile", "Profiles", "Home",new { id = Session["user"] },new { area=""})</li>
                    <li class="@(ViewBag.Title=="Result"?"active":"")">@Html.ActionLink("Result", "result", "Home")</li>
                  
                    <li class="@(ViewBag.Title=="Shoping"?"active":"")">@Html.ActionLink("Shoping", "Shoping", "Home")</li>

                    <li class="@(ViewBag.Title=="Message"?"active":"")">@Html.ActionLink("Chat", "Message", "Home")</li>

                    <li class="@(ViewBag.Title=="News"?"active":"")"><a id="News" href="@Url.Action("News", "Home")"> News</a></li>
                    <li style="width:15px" id="notify"></li>
                    <li>
                        <button onclick="getMessages()" class="btn btn-default btn-group-sm btn-link" style="font-size:24px;">
                            <span class="glyphicon glyphicon-comment"></span>
                        </button>
                        @*<span class="badge badge-notify">1</span>*@
                        <ul id="messagesDrop" class="zaAjaxPoruke dropdown-content"></ul>
                    </li>
                    <li class="dropdown">
                        <button onclick="getRequests()" class="dropbtn"><span class="glyphicon glyphicon-user"></span></button>
                        <span id="notifyFriend"></span>
                        <table id="myDropdown" class="dropdown-content">
                        </table>
                    </li>
                    }
                    else
                    {
                        <li class="@(ViewBag.Title=="PostNews"?"active":"")">@Html.ActionLink("PostNews", "PostNews", "Home")</li>
                    }
                </ul>
                <form id="odjavljivanje" action="@Url.Action("logout", "Home")" method="get">
                    <ul class="nav navbar-nav navbar-right">
                        @if (Session["user"] != null)
                        {


                            <li>@Html.ActionLink(Session["user"].ToString(), "Profiles", "Home", new { id = Session["user"] }, new { area = "" })</li>
                            <li>
                                <button type="submit" class="btn btn-sm navbar-btn" style="background-color:#333333;color:white" >Log-Out&nbsp;&nbsp;<span class="glyphicon glyphicon-log-out"></span></button>
                                @*<a class="navbar-link" onclick="document.getElementById('odjavljivanje').submit()">Log-Out&nbsp;&nbsp;<span class="glyphicon glyphicon-log-out"></span></a>*@
                            </li>
                        }
                    </ul>
                </form>

            </div>
        </div>
    </div>
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    <script src="~/Scripts/MyScript.js"></script>
    <script type="text/javascript" src="~/Scripts/canvasjs.min.js"></script> 
    <div class="container body-content">
        <ul id="pr"></ul>
        @RenderBody()
        <hr />

        <footer>
            <p>&copy; @DateTime.Now.Year - My ASP.NET Application</p>
        </footer>
    </div>


    <script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.

            var chat = $.connection.WomHub;
            // Create a function that the hub can call back to display messages.
            chat.client.News = function (poruka,datum,number) {

                notification(number);
                $('#mesage').prepend("<p style='background-color:darkred'><strong><span style='color:white'> "+ poruka +"<br /><span style='color:#808080'>"+datum + "</span></strong></p></li>")


            };

            chat.client.primiPoruku = function (message, kome, datum) {

                    var upisiPoruku = $("#" + kome + "m");
                    upisiPoruku.append(" <li><p style='background-color:darkred'><strong><span style='color:white;float:left'>" + message + " </span> <br /> <span style='color:#808080'>" + datum + "</span></strong></p></li>");
                    if ( document.getElementsByClassName('zaPoruke').length!=0) {
                        $(".zaPoruke").animate({ scrollTop: document.getElementsByClassName('zaPoruke')[0].scrollHeight }, "fast");
                    }

                //samo za poruke ce se sredi to
            }

            chat.client.mojaPoruka=function(message,sebi,datum){
                var upisiPoruku = $("#" + sebi + "m");
                upisiPoruku.append(" <li><p style='background-color:darkblue'><strong><span style='color:white;float:right'>" + message + " </span> <br /> <span style='color:#808080'>" + datum + "</span></strong></p></li>");
                if (document.getElementsByClassName('zaPoruke').length!=0) {
                    $(".zaPoruke").animate({ scrollTop: document.getElementsByClassName('zaPoruke')[0].scrollHeight }, "fast");
                }


            }

            chat.client.onlineSam = function (name,avatar) {

                var update = $("#" + name);

                update.empty();
                update.prepend(" <div class='circle'></div>");
                update.append("<div style='float:left'><img src=http://localhost:5611/Images/"+avatar+" width='15' height='15' />&nbsp;</div>");
                update.append("<div style='float:left'><strong><a href=http://localhost:5611/Home/Profiles/" + name +">"+name+"</a>&nbsp;</strong></div>");


            }

            chat.client.offSam = function (name,avatar) {
                var update = $("#" + name);
                update.empty();
                update.append("<div style='float:left'><img src=http://localhost:5611/Images/" + avatar + " width='15' height='15' />&nbsp;</div>");
                update.append("<div style='float:left'><strong><a href=http://localhost:5611/Home/Profiles/" + name + ">" + name + "</a>&nbsp;</strong></div>");
            }

            chat.client.Prihvacen = function (username,avatar) {
                $('#reqMess').empty();
                $('#reqMess').append("<button id='msg' onclick='posaljiP()' value='" + username + "' class='btn btn-primary btn-success'>Send Message &nbsp;<span class='glyphicon glyphicon-user'></span></button>");
                $('#reqMess').append("<textarea id='posalji' placeholder='Posalji poruku ' class='dropdown-content'></textarea> <strong id='isSend'></strong>");
                posaljiP = function () {
                    document.getElementById("posalji").classList.toggle("show");
                }
                $('#posalji').keypress(function (e) {
                    var key = e.which;
                    if (key == 13)  // the enter key code
                    {
                        chat.server.posaljiPoruku($('#posalji').val(), $('#msg').val());
                        $('#posalji').val('')
                        var obavestenje = document.getElementById("isSend");
                        if (obavestenje != null)
                            obavestenje.innerHTML = "Poruka poslata"
                        document.getElementById("posalji").classList.toggle("show");

                    }
                });
                // zp(username);
                @{ 
                    var my = Session["user"].ToString();

                }
               
                    var noviPrijatelj = $('#friends');
                    noviPrijatelj.append(" <li id='" + username + "'><div style='float:left'><img src=http://localhost:5611/Images/" + avatar + " width='15' height='15' />&nbsp;</div> <div style='float:left'><strong><a href=http://localhost:5611/Home/Profiles/" + username + ">" + username + "</a>&nbsp;</strong></div> <div class='circle'></div></li>");
                
            }

            chat.client.Odbijen = function (username) {
                $('#reqMess').empty();
                $('#reqMess').append("<button id='request'  value='" + username + "' class='posalji btn btn-primary btn-primary'>Send Request &nbsp;<span class='glyphicon glyphicon-user'></span></button>");
                $('.posalji').click(function () {
                    chat.server.friendRequest('@Session["user"].ToString()', $(this).val())
                    var x = $('#reqMess');
                    x.empty();
                    x.append("<span><strong>Zahtev za Prijateljstvo poslat</strong></span>");
                });
            }

            $('#posalji').keypress(function (e) {
                var key = e.which;
                if (key == 13)  // the enter key code
                {
                    chat.server.posaljiPoruku($('#posalji').val(), $('#msg').val());
                    $('#posalji').val('')
                    var obavestenje = document.getElementById("isSend");
                    if(obavestenje!=null)
                    obavestenje.innerHTML = "Poruka poslata"
                    document.getElementById("posalji").classList.toggle("show");

                }
            });




            chat.client.Notify = function (num) {
                $('#notifyFriend').empty();
                if (num > 0) {
                    notifyFriendRequest(num);
                }
            }

            // Start the connection.
            $.connection.hub.qs = { "Name": '@Session["user"].ToString()' };
            $.connection.hub.start().done(function () {
                $('#post').click(function () {

                    chat.server.send($('#poruka').val());


                }

                );

                $("#odjavljivanje").submit(function (event) {
                    console.log("uso");
                    chat.server.offlineSam();
                });

                $('.posalji').click(function () {
                    chat.server.friendRequest('@Session["user"].ToString()', $(this).val())
                    var x = $('#reqMess');
                    x.empty();
                    x.append("<span><strong>Zahtev za Prijateljstvo poslat</strong></span>")


                });


                getMessages = function () {
                    console.log("hah");

                    $.ajax({
                        type: 'get',
                        dataType: 'json',
                        cache: false,
                        url: '/Home/getM',
                        success: function (obj) {
                            var response = JSON.parse(obj);
                            var dropdown = $('#messagesDrop');


                            dropdown.empty();
                            if (jQuery.isEmptyObject(response)) {
                                dropdown.prepend("<li><strong>NemaPoruka</strong></li>")

                            }

                            document.getElementById("messagesDrop").classList.toggle("show");
                            $.each(response, function (i, f) {
                                dropdown.append("<li style='background-color:lightblue'><a href='http://localhost:5611/Home/Message/" + f.Sender + "'><p><img src='http://localhost:5611/Images/" + f.Jpg + "' width='25' height='25' />&nbsp;<span><strong>" + f.Sender + "</strong><span></p><p>" + f.Message + "</p></a><p style='color:#808080'>" + f.Datum + "</p></li>");
                                dropdown.append("<li height='1'></li>")

                            });
                        }
                    });
                    }




                getRequests = function () {

                    $.ajax({
                        type: 'get',
                        dataType: 'json',
                        cache: false,
                        url: '/Home/getRequests',
                        success: function (obj) {
                            var response = JSON.parse(obj);
                            var dropdown = $('#myDropdown');
                            console.log(obj);

                            dropdown.empty();
                            if (jQuery.isEmptyObject(response)) {
                                dropdown.prepend("<tr><td><strong>Nemate zahteva za prijateljstvo</strong></td></tr>");

                            }
                            $.each(response, function (i, f) {
                                console.log(f);
                                dropdown.prepend("<tr><td><a href='http:http://192.168.0.101:5000/Home/Profiles/" + f.Username + "'><img src=http:http://192.168.0.101:5000/Images/" + f['Avatar'] + " width='20' height='20' />&nbsp;<strong>" + f.Username + "</strong></a></td>&nbsp;<td><button class='btn btn-sm btn-success' value='" + f.Username + "' id='" + f.Username + "a'>Accept&nbsp:<span class='glyphicon glyphicon-user'></span></button></td><td>&nbsp;<button class='btn btn-sm btn-danger' value='" + f.Username + "' id='" + f.Username + "d'>Deny&nbsp;<span class='glyphicon glyphicon-trash'></span></button></td></tr>")

                                document.getElementById(f.Username + "a").onclick = function () {
                                    var cale = this.parentElement.parentElement;
                                    var proba = this.parentElement.parentElement.parentElement;
                                    proba.removeChild(cale);
                                    chat.server.af(f.Username);

                                }
                                document.getElementById(f.Username + "d").onclick = function () {
                                    var cale = this.parentElement.parentElement;
                                    var proba = this.parentElement.parentElement.parentElement;
                                    proba.removeChild(cale);
                                    chat.server.df(f.Username);

                                }

                            });

                            document.getElementById("myDropdown").classList.toggle("show");
                        }
                    });
                }

            });
        });
    </script>
    @RenderSection("scripts", required: false)
</body>
</html>
